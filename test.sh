#!/bin/bash

assert() {
  input=$1
  expected=$2

  ./occ "$input" > tmp.s
  gcc -o tmp tmp.s
  ./tmp
  actual=$?

  if [ $actual = $expected ]
  then
    echo "$input => $actual"
  else
    echo "$input => expected $expected, but got $actual"
    exit 1
  fi
}

assert "int main() { return 42; }" "42"
assert "int main() { return 123; }" "123"
assert "int main() { return 42+3; }" "45"
assert "int main() { return 42  + 13 ; }" "55"
assert "int main() { return 42+3+12; }" "57"
assert "int main() { return 42+3+12+2; }" "59"
assert "int main() { return 44-2; }" "42"
assert "int main() { return 44+22-34-12; }" "20"
assert "int main() { return 2*34; }" "68"
assert "int main() { return 2*3*4; }" "24"
assert "int main() { return 2*34-3; }" "65"
assert "int main() { return 12+2*4-3; }" "17"
assert "int main() { return 12/4; }" "3"
assert "int main() { return 12/5; }" "2"
assert "int main() { return 12+4/2-3; }" "11"
assert "int main() { return 12+3*4/2-3; }" "15"
assert "int main() { return (12+3)*4; }" "60"
assert "int main() { return (12+3)*4/(1+2); }" "20"
assert "int main() { return 1; 2; return 3; }" "1"
assert "int main() { 1; return 2; return 3; }" "2"
assert "int main() { 1; 2; return 3; }" "3"
assert "int main() { int a=5; return a; }" "5"
assert "int main() { int a=5+2; return a; }" "7"
assert "int main() { int a=5; int b=123; return a; }" "5"
assert "int main() { int a=5; int b=123; return b; }" "123"
assert "int main() { int a; int b; a=b=123; return a; }" "123"
assert "int main() { int a; int b; a=b=123; return b; }" "123"
assert "int main() { int var=12; int foo=23; return var; }" "12"
assert "int main() { int var=12; int foo=23; return foo; }" "23"
assert "int main() { int a=5; a=6; return a; }" "6"
assert "int ret42() { return 42; } int main() { return ret42(); }" "42"
assert "int main() { { 1; 2; 3; } return 4; }" "4"
assert "int main() { { 1; return 2; 3; } return 4; }" "2"
assert "int main() { ; return 3; }" "3"
assert "int main() { if (0) return 12; return 23; }" "23"
assert "int main() { if (1) return 12; return 23; }" "12"
assert "int main() { if (2) return 12; return 23; }" "12"
assert "int main() { if (0) { return 12; } return 23; }" "23"
assert "int main() { if (1) { return 12; } return 23; }" "12"
assert "int main() { int cond=0; if (cond) { return 12; } return 23; }" "23"
assert "int main() { int cond=1; if (cond) { return 12; } return 23; }" "12"
assert "int main() { if (1) { if (1) return 12; return 23; } return 34; }" "12"
assert "int main() { if (1) { if (0) return 12; return 23; } return 34; }" "23"
assert "int main() { if (0) { if (0) return 12; return 23; } return 34; }" "34"
assert "int main() { if (0) return 12; else return 23; return 34; }" "23"
assert "int main() { if (1) return 12; else return 23; return 34; }" "12"
assert "int main() { if (0) { return 12; } else { return 23; } return 34; }" "23"
assert "int main() { if (1) { return 12; } else { return 23; } return 34; }" "12"
assert "int main() { int i = 3; ++i; return i; }" "4"
assert "int main() { int i = 3; ++i; ++i; return i; }" "5"
assert "int main() { int i = 3; ++i; return ++i; }" "5"
assert "int main() { int i = 3; --i; return i; }" "2"
assert "int main() { int i = 3; --i; --i; return i; }" "1"
assert "int main() { int i = 3; --i; return --i; }" "1"
assert "int main() { int i = 7; ++i, ++i; return i; }" "9"
assert "int main() { int i = 7; ++i, i = 42, ++i; return i; }" "43"
assert "int main() { int i = 3; i++; return i; }" "4"
assert "int main() { int i = 3; return i++; }" "3"
assert "int main() { int i = 3; i--; return i; }" "2"
assert "int main() { int i = 3; return i--; }" "3"
assert "int main() { return 3 < 5; }" "1"
assert "int main() { return 3 > 5; }" "0"
assert "int main() { int i=3; return i < 5; }" "1"
assert "int main() { int i=4; return i < 5; }" "1"
assert "int main() { int i=5; return i < 5; }" "0"
assert "int main() { int i=6; return i < 5; }" "0"
assert "int main() { int i=3; return i > 5; }" "0"
assert "int main() { int i=4; return i > 5; }" "0"
assert "int main() { int i=5; return i > 5; }" "0"
assert "int main() { int i=6; return i > 5; }" "1"
assert "int main() { int i=3; return i+1 < 5; }" "1"
assert "int main() { int i=3; return i+2 < 5; }" "0"
assert "int main() { int i=3; return i <= 5; }" "1"
assert "int main() { int i=4; return i <= 5; }" "1"
assert "int main() { int i=5; return i <= 5; }" "1"
assert "int main() { int i=6; return i <= 5; }" "0"
assert "int main() { int i=3; return i >= 5; }" "0"
assert "int main() { int i=4; return i >= 5; }" "0"
assert "int main() { int i=5; return i >= 5; }" "1"
assert "int main() { int i=6; return i >= 5; }" "1"
assert "int main() { return 3==3; }" "1"
assert "int main() { return 3==4; }" "0"
assert "int main() { int i=3; return i==3; }" "1"
assert "int main() { int i=3; return i==4; }" "0"
assert "int main() { return 3!=3; }" "0"
assert "int main() { return 3!=4; }" "1"
assert "int main() { int i=3; return i!=3; }" "0"
assert "int main() { int i=3; return i!=4; }" "1"
assert "int main() { for(;;) return 12; return 23; }" "12"
assert "int main() { int i=0; for(; i<10; i++); return i; }" "10"
assert "int main() { int i=0; for(; i<10; i++) { if (i == 5) return i; } return i; }" "5"
assert "int main() { int i=0; for(i=3; i<10; i++) { if (i == 5) return i; } return i; }" "5"
assert "int main() { int i=0; for(i=6; i<10; i++) { if (i == 5) return i; } return i; }" "10"
assert "int main() { int k=10; for(int i=0; i<3; i++) k++; return k; }" "13"
assert "int main() { int k=10; for(int i=0; i<3; i++) { for(int j=0; j<2; j++) k++; } return k; }" "16"
assert "int main() { for(;;) { break; return 12; } return 23; }" "23"
assert "int main() { int i; for(i=0; i<10; i++) { if(i==3) break; } return i; }" "3"
assert "int main() { for(;;) { for(;;) { break; return 12; } return 23; } return 34; }" "23"
assert "int main() { int n=1; for(int i=0; i<5; i++) { if (i>3) continue; n=n*2; } return n; }" "16"
assert "int main() { int i=0; while(i<3) i++; return i; }" "3"
assert "int main() { int i=0; while(i<3) { break; i++; } return i; }" "0"
assert "int main() { int i=0; do i++; while (i<10); return i; }" "10"
assert "int main() { int i=0; int j=1; do { j=j*2; i++; } while (i<3); return j; }" "8"
assert "int main() { int i=3; do { break; i++; } while (i<10); return i; }" "3"
assert "int ret(int n) { return n; } int main() { return ret(123); }" "123"
assert "int ret(int n) { return n; } int main() { int var=42; return ret(var); }" "42"
assert "int ret(int n) { return n; } int main() { int var=24; int foo=ret(var); return foo; }" "24"
assert "int ret_add(int a, int b) { return a+b; } int main() { return ret_add(3, 4); }" "7"
assert "int main() { char c = 12; return c; }" "12"
assert "char add_char(char a, char b, char c) { return a+b+c; } int main() { return add_char(1,2,3); }" "6"
assert "int main() { return 'A'; }" "65"
assert "int main() { char c='a'; return c; }" "97"
assert "int main() { int a=42; int *p=&a; return *p; }" "42"
# assert "int main() { int a=42; int *p=&a; *p=123; return *p; }" "123"
# assert "int main() { int a=42; int *p=&a; *p=123; return a; }" "123"
# assert "int change(int *ptr) { *ptr=123; } int main() { int a=42; int *p=&a; change(p); return *p; }" "123"
# assert "int change(int *ptr) { *ptr=123; } int main() { int a=42; int *p=&a; change(p); return a; }" "123"

# sizeof
assert "int main() { int a; return sizeof(a); }" "4"
assert "int main() { return sizeof(int); }" "4"
assert "int main() { char c; return sizeof(c); }" "1"
assert "int main() { return sizeof(char); }" "1"
assert "int main() { int a=42; int *p=&a; return sizeof(p); }" "8"
assert "int main() { return sizeof(int*); }" "8"

echo OK
exit 0
